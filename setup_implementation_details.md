# Ollama Workbench Setup Implementation

This document contains the complete implementation details for the new setup files. Since Architect mode can only edit markdown files, you'll need to switch to Code mode to implement these changes.

## 1. New `setup.sh` Script

Replace the existing `setup.sh` with this optimized version:

```bash
#!/bin/bash

# ========== Ollama Workbench Setup Script for Apple Silicon ==========
# This script automates the installation of Ollama Workbench with
# optimized dependencies for Apple Silicon (M1/M2/M3/M4) Macs.
# ===================================================================

# Terminal colors for better user experience
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Print styled text
print_step() {
    echo -e "${CYAN}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check Apple Silicon
is_apple_silicon() {
    if [[ "$(uname -m)" == "arm64" ]]; then
        return 0
    else
        return 1
    fi
}

# Function to create a placeholder groq_utils.py file if needed
create_placeholder_groq_utils() {
    if [ ! -f "groq_utils.py" ]; then
        cat > groq_utils.py << EOL
# Placeholder for groq_utils.py
# This file was auto-generated by the installer

GROQ_MODELS = []

def get_local_embeddings(*args, **kwargs):
    """
    Placeholder function for get_local_embeddings.
    """
    return None
EOL
        print_success "Created placeholder groq_utils.py file"
    fi
}

# Main installation process
echo -e "${CYAN}=======================================${NC}"
echo -e "${CYAN}   Ollama Workbench Setup for Apple Silicon   ${NC}"
echo -e "${CYAN}=======================================${NC}"

# Check if running on Apple Silicon
if is_apple_silicon; then
    print_success "Detected Apple Silicon Mac"
else
    print_warning "This script is optimized for Apple Silicon Macs. Some optimizations may not apply."
fi

# Check for Python 3.11+
if ! command_exists python3 || [ "$(python3 -c 'import sys; print(int(sys.version_info.major == 3 and sys.version_info.minor >= 11))')" = "0" ]; then
    print_error "Python 3.11 or higher is required"
    echo "Please install Python 3.11+ from https://www.python.org/downloads/"
    exit 1
else
    print_success "Python 3.11+ is installed"
fi

# Check for Poetry
if ! command_exists poetry; then
    print_step "Poetry not found, installing..."
    curl -sSL https://install.python-poetry.org | python3 -
    if ! command_exists poetry; then
        print_error "Failed to install Poetry"
        exit 1
    fi
    print_success "Poetry installed successfully"
else
    print_success "Poetry is already installed"
fi

# Configure Poetry
print_step "Configuring Poetry..."
poetry config virtualenvs.in-project true
print_success "Poetry configured"

# Remove existing conda environment if it exists
if command_exists conda; then
    print_warning "Found conda installation"
    if conda env list | grep -q "ollamaworkbench"; then
        print_step "Removing existing conda environment..."
        conda remove --name ollamaworkbench --all -y
        print_success "Removed conda environment"
    fi
fi

# Check for existing Poetry environment
if [ -d ".venv" ]; then
    print_warning "Existing Poetry virtual environment found"
    read -p "Do you want to remove it and start fresh? (y/N): " remove_env
    if [[ $remove_env =~ ^[Yy]$ ]]; then
        print_step "Removing existing Poetry environment..."
        rm -rf .venv
        print_success "Removed existing virtual environment"
    fi
fi

# Install dependencies
print_step "Installing dependencies using Poetry..."
# First, make sure pyproject.toml exists
if [ ! -f "pyproject.toml" ]; then
    print_error "pyproject.toml not found. Please ensure you're in the correct directory."
    exit 1
fi

# Install dependencies from pyproject.toml
poetry install

if [ $? -ne 0 ]; then
    print_error "Poetry install failed. Attempting to fix common issues..."
    
    # Create placeholder groq_utils.py if it doesn't exist
    create_placeholder_groq_utils
    
    # Try installing without some problematic dependencies first
    print_step "Installing base dependencies..."
    poetry run pip install --upgrade pip
    
    # If we're on Apple Silicon, install torch with MPS support
    if is_apple_silicon; then
        print_step "Installing PyTorch with Apple Silicon (MPS) support..."
        poetry run pip install torch==2.3.0 torchvision==0.18.0 --extra-index-url https://download.pytorch.org/whl/nightly/cpu
    else
        print_step "Installing PyTorch..."
        poetry run pip install torch torchvision
    fi
    
    # Install transformers before sentence-transformers to avoid dependency issues
    print_step "Installing transformers..."
    poetry run pip install transformers==4.38.0
    
    print_step "Installing sentence-transformers..."
    poetry run pip install sentence-transformers==2.5.0
    
    # Try poetry install again
    print_step "Resuming Poetry installation..."
    poetry install --no-interaction
fi

# Create placeholder groq_utils.py if it doesn't exist (in case we didn't hit the error path)
create_placeholder_groq_utils

# Run validation tests
print_step "Running validation tests..."
cat > validation_test.py << EOL
import sys
print("Python version:", sys.version)

# Test PyTorch installation
try:
    import torch
    print("PyTorch version:", torch.__version__)
    if torch.cuda.is_available():
        print("CUDA is available")
    else:
        print("CUDA is not available")
    
    if hasattr(torch, 'mps') and torch.mps.is_available():
        print("MPS (Metal Performance Shaders) is available - Apple Silicon optimization working!")
    else:
        print("MPS is not available")
except ImportError as e:
    print("Failed to import torch:", e)

# Test torchvision installation
try:
    import torchvision
    print("Torchvision version:", torchvision.__version__)
except ImportError as e:
    print("Failed to import torchvision:", e)

# Test sentence-transformers installation
try:
    import sentence_transformers
    print("Sentence-transformers version:", sentence_transformers.__version__)
except ImportError as e:
    print("Failed to import sentence_transformers:", e)

# Test other key dependencies
dependencies = [
    "streamlit", "langchain", "transformers", "ollama",
    "chromadb", "pandas", "psutil", "requests"
]

for dep in dependencies:
    try:
        module = __import__(dep)
        version = getattr(module, "__version__", "unknown")
        print(f"{dep} version: {version}")
    except ImportError as e:
        print(f"Failed to import {dep}:", e)

# Test import of application modules
try:
    import ollama_utils
    print("Successfully imported ollama_utils")
except ImportError as e:
    print("Failed to import ollama_utils:", e)
EOL

poetry run python validation_test.py
rm validation_test.py

# Check if Ollama is installed
if ! command_exists ollama; then
    print_warning "Ollama is not installed"
    echo "It's recommended to install Ollama to use all features of Ollama Workbench."
    echo "You can install Ollama by running: curl -fsSL https://ollama.com/install.sh | sh"
else
    print_success "Ollama is installed"
fi

print_success "Installation complete!"
echo -e "${GREEN}=======================================${NC}"
echo -e "${GREEN}   Ollama Workbench is ready to use!   ${NC}"
echo -e "${GREEN}=======================================${NC}"
echo ""
echo -e "To run Ollama Workbench, use: ${CYAN}bash run_ollama_workbench.sh${NC}"
echo ""
```

## 2. Updated `pyproject.toml`

Update the `pyproject.toml` file with these specific dependencies:

```toml
[tool.poetry]
name = "ollama-workbench"
version = "0.1.0"
description = "A streamlined setup for Ollama Workbench"
authors = ["Your Name <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.11"
langchain-community = "0.2.15"
langchain = "0.2.15"
pyautogen = "0.2.35"
Flask-Cors = "5.0.0"
Flask = "3.0.3"
Requests = "2.32.3"
beautifulsoup4 = "4.12.3"
bs4 = "0.0.2"
duckduckgo-search = "4.1.1"
fake-useragent = "1.5.1"
google-api-python-client = "2.143.0"
httpx = "0.27.0"
playwright = "1.46.0"
selenium = "4.24.0"
serpapi = "0.1.5"
webdriver-manager = "4.0.2"
fastapi = "0.109.2"
uvicorn = "0.27.1"
python-multipart = "0.0.9"
aiofiles = "23.2.1"
pygame = "2.6.1"
pydub = "0.25.1"
GPUtil = "1.4.0"
bleach = "6.1.0"
cursor = "1.3.5"
humanize = "4.10.0"
networkx = "3.3"
psutil = "6.0.0"
rich = "13.8.0"
schedule = "1.2.2"
tqdm = "4.66.5"
Markdown = "3.6"
PyPDF2 = "3.0.1"
fpdf = "1.7.2"
mdutils = "1.6.0"
pdfkit = "1.0.0"
reportlab = "4.2.2"
PyYAML = "6.0.2"
Pygments = "2.18.0"
flake8 = "7.1.1"
pytest-html = "4.1.1"
pytest = "8.3.2"
radon = "6.0.1"
ruff = "0.6.3"
chromadb = "0.5.5"
google_search_results = "2.4.2"
matplotlib = "3.9.2"
setuptools = "69.5.1"
streamlit-flow-component = "1.2.9"
# Apple Silicon optimized dependencies
torch = "2.3.0"
torchvision = "0.18.0"
sentence-transformers = "2.5.0"
transformers = "4.38.0"
ollama = "0.2.0"
streamlit = "1.32.0"
streamlit-extras = "0.3.6"
tiktoken = "0.6.0"
autogen = "0.2.35"
pandas = "2.2.0"
datetime = "5.4"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.backend"
```

## 3. Updated `run_ollama_workbench.sh`

Replace the existing `run_ollama_workbench.sh` with this improved version:

```bash
#!/bin/bash

# ========== Ollama Workbench Runner Script ==========
# This script runs the Ollama Workbench application
# ===================================================

# Terminal colors for better user experience
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Print styled text
print_step() {
    echo -e "${CYAN}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check if Ollama server is running
is_ollama_running() {
    curl -s http://localhost:11434/api/tags > /dev/null
    return $?
}

# Check if Poetry is installed
if ! command_exists poetry; then
    print_error "Poetry is not installed. Please run setup.sh first."
    exit 1
fi

# Check if Ollama is installed
if ! command_exists ollama; then
    print_warning "Ollama is not installed."
    read -p "Do you want to install Ollama now? (Y/n): " install_ollama
    if [[ $install_ollama =~ ^[Nn]$ ]]; then
        print_warning "Continuing without Ollama. Some features may not work."
    else
        print_step "Installing Ollama..."
        curl -fsSL https://ollama.com/install.sh | sh
        if [ $? -ne 0 ]; then
            print_error "Failed to install Ollama."
            exit 1
        fi
        print_success "Ollama installed successfully."
    fi
fi

# Check if Ollama server is running
if ! is_ollama_running; then
    print_warning "Ollama server is not running."
    read -p "Do you want to start the Ollama server now? (Y/n): " start_ollama
    if [[ $start_ollama =~ ^[Nn]$ ]]; then
        print_warning "Continuing without Ollama server. Some features may not work."
    else
        print_step "Starting Ollama server..."
        # Start Ollama server in the background
        ollama serve > /dev/null 2>&1 &
        OLLAMA_PID=$!
        
        # Wait for server to start
        print_step "Waiting for Ollama server to start..."
        for i in {1..30}; do
            if is_ollama_running; then
                print_success "Ollama server started successfully."
                break
            fi
            sleep 1
            if [ $i -eq 30 ]; then
                print_error "Ollama server failed to start within the timeout period."
                exit 1
            fi
        done
    fi
fi

# Create a trap to handle SIGINT and SIGTERM
cleanup() {
    print_step "Shutting down..."
    if [ -n "$STREAMLIT_PID" ]; then
        kill $STREAMLIT_PID 2>/dev/null
    fi
    exit 0
}

trap cleanup SIGINT SIGTERM

# Run the Streamlit app using Poetry
print_step "Starting Ollama Workbench..."
poetry run streamlit run main.py &
STREAMLIT_PID=$!

# Wait for the Streamlit process to finish
wait $STREAMLIT_PID
```

## 4. Implementation Steps

1. Switch to Code mode
2. Create the new setup.sh script using the content above
3. Update the pyproject.toml file with the new dependencies
4. Update the run_ollama_workbench.sh script with the improved version
5. Test the installation on an Apple Silicon Mac

## 5. Testing Steps

After implementing these changes:

1. Run the new setup script: `bash setup.sh`
2. Verify that PyTorch with MPS support is installed correctly
3. Check that all dependencies are properly resolved
4. Run the application: `bash run_ollama_workbench.sh`
5. Verify that there are no import errors or torch-related issues

These changes should create a streamlined installation experience that works seamlessly on Apple Silicon Macs while resolving the dependency conflicts.